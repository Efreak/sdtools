<html>
  <head>
    <link rel="icon" type="image/x-icon" href="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDUuMC45AP/bAEMAAgEBAQEBAgEBAQICAgICBAMCAgICBQQEAwQGBQYGBgUGBgYHCQgGBwkHBgYICwgJCgoKCgoGCAsMCwoMCQoKCv/bAEMBAgICAgICBQMDBQoHBgcKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCv/AABEIABAAEAMBEgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APyt1zXNP+MGntp+nybkbhmFGuaHp/wf09tQ0+Pai8sor92xP1j2P/Crbl8tj8Dwv1X23/CTfm8w0PXNP+D+nrp+oSbUXhWNGh6Hp/xg09dQ1CPcjcqpp4X6z7Ff2Xbl8wxX1X2r/ta/N5H/2Q==">
    <title>Style Your Prompt</title>
    <style>
      body{
        font-family: monospace;
        width: 100%;
        height: 100%;
        margin: 0;
        overflow: hidden;
        background: #0d0d0d;
        color: #eee;
      }
      input{
        background-color: rgba(255, 255, 255, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #eee;
        border-radius: 8px;
      }
      textarea{
        background-color: rgba(255, 255, 255, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #eee;
        border-radius: 8px;
      }
      .main-container{
        display: inline-block;
        margin: 0 50%;
        transform: translate( -50%, 0 );
        width: 1280px;
        padding: 5px;
        background-color: rgba(50, 50, 50, 0.8);
      }

      #a_list{
        padding: 5px 25px;
      }
      a {
        color: #eee;
        clear: left;
        display: block;
        margin-top: 15px;
      }
      a:hover {
        color: #ff5500;
      }
      a:active {
        color: #ff5500;
      }
      
      .inline_menu_item {
        color: #eee;
        clear: left;
        display: inline-block;
        margin: 5px 5px 5px 5px;
        cursor: pointer;
      }
      .inline_menu_item:hover {
        color: #ff5500;
      }
      .inline_menu_item:active {
        color: #ff5500;
      }


      .left_panel{
        padding-left: 10px;
        width: 280px;
        display: inline-block;
        float: left;
      }
      .right_panel{
        width: 980px;
        display: inline-block;
        float: left;
        position: relative;
      }
      #styles_slider{
        width: 100%;
        height: 800px;
        overflow-y: scroll;
      }

      #styles_slider .item{
        width: 186px;
        margin: 3px ;
        display: inline-block;
        cursor: pointer;
        position: relative;
      }
      
      #styles_slider .item.mixed{ 
        box-shadow: 0 0 4px 4px #ee00ff;
        border-radius: 8px;
      }

      #styles_slider .item img{
        width: 100%;
        height: 230px;
        border-radius: 8px;
      }

      #styles_slider .item_name{
        position: absolute;
        bottom: 10px;
        left: 10px;
        font-size: 16px;
        text-shadow: 2px 3px 1px BLACK, 1px 0px 6px BLACK;
      }

      /* Стилізація для Chrome, Safari, Edge */
      /* Весь скроллбар */
      #styles_slider::-webkit-scrollbar {
          width: 12px;
      }

      /* Трек (фон скроллбару) */
      #styles_slider::-webkit-scrollbar-track {
          background: #f1f1f1;
          border-radius: 10px;
      }

      /* Повзунок (слайдер) */
      #styles_slider::-webkit-scrollbar-thumb {
          background-color: #888;
          border-radius: 10px;
          border: 3px solid #f1f1f1; /* Відстань між слайдером та краями */
      }

      /* При наведенні миші */
      #styles_slider::-webkit-scrollbar-thumb:hover {
          background-color: #555;
      }

      /* Для Firefox */
      #styles_slider {
          scrollbar-width: thin; /* Тонкий скроллбар */
          scrollbar-color: #888 #f1f1f1; /* Колір: слайдер і трек */
      }

      .board_section{
        display: inline-block; 
        float: left; 
        margin-left: 5px;
        margin-bottom: 10px;
      }

      small{
        font-size: 10px;
        color: #777;
      }

      .hidden{
        visibility: hidden;
        height: 0px;
      } 

      #tab_add_new_style textarea{
        width: 500px;
        height: 80px;
      } 

      .remove_icon{
        position: absolute;
        top: 0px;
        right: 10px;
        font-size: 16px;
        font-weight: bold;
      }

      img.place_before{
        border-left: 1px solid #ff5500;
      }

      #selected_style_name {
        text-shadow: 3px 4px 0px #000;
      }

      .style_mixer_checkbox{
        position: absolute;
        top: 4px;
        left: 4px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
      }

      .sub_navbar{

      }

      .sub_navbar span{
        cursor: pointer;
      }
      .sub_navbar span:hover *{
        color: #ff5500;
      }
      .sub_navbar span:active *{
        color: #ff5500;
      }

      .sub_navbar span.active {
        border-bottom: 1px solid #ff5500;
      }

    </style>
    <script src="https://cdn.jsdelivr.net/gh/cferdinandi/tabby@12/dist/js/tabby.polyfills.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/cferdinandi/tabby@12/dist/css/tabby-ui.css">
  </head>
  <body>
    <div class="main-container">
      <div id="edit_menu">
        <input type="file" accept=".json" id="navbar_load_db_upload_file" style="display: none;">
        <span class="inline_menu_item" id="navbar_load_db">load styles</span>
        <span class="inline_menu_item" id="navbar_save_db">save styles</span>
      </div>

      <ul data-tabs>
        <li><a data-tabby-default href="#tab_main_styler">Main Styler</a></li> 
        <li><a href="#tab_add_new_style">Create New</a></li>
      </ul>

      <!-- Main Styler -->
      <div id="tab_main_styler">
        <div class="sub_navbar" style="float: right;">
          <span class="switch_mode" data-value="randomize"><small>randomize</small></span> 
          <span class="switch_mode" data-value="mixer"><small>mixer</small></span> 
          <span class="switch_mode" data-value="editor" id="switch_edit_mode"><small>edit</small></span>
        </div>
        <h4>Stable Diffusion styles for prompt:</h4>
        <div class="left_panel" >
          Your prompt: <br>
          <textarea name="" id="from_positive" cols="30" rows="9"></textarea><br><br><br> 
          <!-- negative: <br> -->
          <!-- <textarea name="" id="from_negative" cols="60" rows="5"  style="display: none;"></textarea><br> --> 
          <h4 id="selected_style_name"></h4>
          <div id="special_modes_control" >
            <div id="mix_limiter" class="hidden" 
            title="maximum of elements in result, need to limit the finally prompt (negative is 50% of limit)">
              Mix limiter: 
              <input id="mix_limiter_input" type="number" min="1" max="100" step="1" value="15">
              <button id="mix_button">mix</button>
            </div>
            <div id="randomize_style" class="hidden"
            title="maximum of elements in result, need to limit the finally prompt (negative is 50% of limit)">
              Random limiter: 
              <input id="randomize_limiter_input" type="number" min="1" max="100" step="1"  value="15">
              <button id="randomize_button">run</button>
            </div>
          </div>
          Processed prompt: <br>
          <textarea name="" id="to_positive" cols="30" rows="9"></textarea><br><br>
          Recomended negative prompt: <br>
          <textarea name="" id="to_negative" cols="30" rows="9"></textarea><br><br><br>
          compiled: <br>
          <textarea name="" id="build_for_tele" cols="30" rows="5"></textarea><br> 
        </div>
        <div class="right_panel" >
          <div id="styles_slider"></div>
        </div>
      </div>
      

      <!-- Add New Style -->
      <div id="tab_add_new_style">
        <h4>Add new Style:</h4>

        <div class="board_section">
          New Style Name: <br>
          <input type="text" style="width:500px;" id="new_style_name" /><br><br>
          New Style Prompt: <small>use {prompt} tag to point the place where user prompt will placed</small> <br>
          <textarea name="" id="new_style_positive"></textarea><br><br>
          New Style Negative Prompt: <br>
          <textarea name="" id="new_style_negative"></textarea><br><br> 
          <button id="add_style_button">add style</button>
        </div>
        <div class="board_section">
          <img src="" alt="" id="thumb_image" style="width:128px;height:164px;"><br> 
          From JSON: <br>
          <textarea name="" id="new_style_json"></textarea><br><br> 
        </div>

        <div style="visibility: hidden;" >
          <!-- <div> -->
          <!-- <button id="save_styles">save styles</button><br>  -->
          <textarea name="" id="add_style_area"></textarea><br> 
        </div>
      </div>

    </div>
    <script>

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      const $$ = ( selector ) => { return document.querySelector( selector ); }
      const $$$ = ( selector ) => { return document.querySelectorAll( selector ); }

      let CURRENT_STYLE_INDEX = 0;

      window.onload = ()=> {

        let STYLES = [];

        class StylerEditor {

          constructor( link ){
            this.link_to_init_styles = link;

            this.STYLES = [];
 
            this.elements = {
              switch_edit_mode: $$('#switch_edit_mode'),
              switch_mode: $$$('.switch_mode'),

              mix_limiter: $$('#mix_limiter'),
              mix_limiter_input: $$('#mix_limiter_input'),
              mix_button: $$('#mix_button'),

              randomize_style: $$('#randomize_style'),
              randomize_limiter_input: $$('#randomize_limiter_input'),
              randomize_button: $$('#randomize_button'),

              navbar_load_db_upload_file: $$('#navbar_load_db_upload_file'),
              navbar_loadStyles: $$('#navbar_load_db'),
              navbar_saveStyles: $$('#navbar_save_db'),

              slist_selected_style_name: $$('#selected_style_name'),
              slist_container: $$('#styles_slider'),
              slist_fromPositive: $$('#from_positive'),
              slist_fromNegative: $$('#from_negative'),
              slist_toPositive: $$('#to_positive'),
              slist_toNegative: $$('#to_negative'),

              new_style_image: $$('#thumb_image'),
              new_style_processImage: new Image(),
              new_style_canvas: document.createElement('canvas'),
              new_style_context: null,
              new_style_freader: new FileReader(),
              new_style_createButton: $$('#add_style_button'),
              new_style_nameInput: $$('#new_style_name'),
              new_style_positive: $$('#new_style_positive'),
              new_style_negative: $$('#new_style_negative'),
              new_style_json: $$('#new_style_json'),
            }; 

            this.elements.new_style_context = this.elements.new_style_canvas.getContext('2d');


            this.options = {

              edit_dragstart_index: -1, 
              edit_next_index: -1, 

              thumb_width: 128,
              thumb_height: 164,

              styles_list_current_index: 0,

              create_new_name: null,
              create_new_positive: null,
              create_new_negative: null,
              create_new_image: null,
            };

            this.mode = '';

            this.mixed_items = [];

            this.stack_items_for_randmoize = {
              prompt: [],
              negative: [],
            };

            this.defaults = {
              base_prompt: 'woman, dressed in outfit'
            }

            const link_for_load_base_db = `${link}?time=${ parseInt( Date.now() / 1000000 ) }`;

            if( link ){
              const catchError = ( err ) => {
                this.init();
              };
              fetch( link ).then( ( data ) => {
                data.json().then( ( __json ) => {

                  if( __json ) this.replaceStyles( __json );
                  
                  this.init();

                }, catchError );
              }, catchError );

            } else {

              this.init();
            }

          }

          recalculateRandomItems(){
            
            let allPrompts = [];
            let allNegatives = [];

            for( const nextOptions of this.STYLES ){ 
              const { prompt, negative } = nextOptions; 
              const prompt_withoutPromptTag = prompt.replaceAll('{prompt}', '');
              const prompt_splitedByComa = prompt_withoutPromptTag.split(',');
              allPrompts = allPrompts.concat( prompt_splitedByComa );
              const negative_withoutPromptTag = negative.replaceAll('{prompt}', '');
              const negative_splitedByComa = negative_withoutPromptTag.split(',');
              allNegatives = allNegatives.concat( negative_splitedByComa );
            }

            let allPrompts_finally = [];
            let allNegatives_finally = [];

            for( const nextPrompt of allPrompts ){
              const trimed = nextPrompt.trim();
                if( !allPrompts_finally.includes( trimed ) && trimed !== '' ){
                  allPrompts_finally.push( trimed );
                }
            }

            allPrompts_finally = shuffleArray( allPrompts_finally );

            for( const nextNegative of allNegatives ){
              const trimed = nextNegative.trim();
              if( !allNegatives_finally.includes( trimed ) && trimed !== '' ){
                allNegatives_finally.push( trimed );
              }
            }

            allNegatives_finally = shuffleArray( allNegatives_finally );

            this.stack_items_for_randmoize = {
              prompt: allPrompts_finally,
              negative: allNegatives_finally,
            };

          }

          reset_mixed_styles(){
            this.mixed_items = [];
          }

          replaceStyles( nextStyles ){
            this.STYLES = nextStyles;
            this.recalculateRandomItems();
          }

          initEventListeners(){

            const { mix_button, randomize_button } = this.elements;

            mix_button.addEventListener( 'click', () => { 
              this.render_mixed_style();
            } );

            randomize_button.addEventListener( 'click', () => { 
              this.render_random_style();
            } );


            const { new_style_image, new_style_processImage, new_style_canvas, new_style_context, new_style_freader } = this.elements;

            // drug and drop for edit new style
            this.elements.new_style_image.addEventListener('dragover', (event) => { event.preventDefault(); });
            this.elements.new_style_image.addEventListener('drop', (event) => {
              event.preventDefault();
              const file = event.dataTransfer.files[0];
              if (file && file.type.startsWith('image/')) {
                new_style_freader.onload = (e) => {
                  new_style_processImage.onload = () => {
                    new_style_context.drawImage(
                      new_style_processImage, 
                      0, 0, new_style_processImage.width, new_style_processImage.height,
                      0, 0, new_style_canvas.width, new_style_canvas.height,
                    );
                    const dataURL = new_style_canvas.toDataURL('image/webp', 0.8 );
                    new_style_image.src = dataURL; 
                  }
                  new_style_processImage.src = e.target.result;
                };
                new_style_freader.readAsDataURL(file);
              } else {
                  alert('Будь ласка, перетягніть зображення');
              }
            });

            const { new_style_createButton, new_style_nameInput, new_style_positive, new_style_negative, new_style_json } = this.elements;
            //add new style button 
            new_style_createButton.addEventListener( 'click', () => {
              let _from_textarea = new_style_json.value;
              let _json_from_textarea = {};
              try{
                _json_from_textarea = JSON.parse( _from_textarea );
              }catch( err ){
                console.warn( err );
              }

              const thumb_data_url = new_style_image.src;
              const _json = {
                name: _json_from_textarea.name || new_style_nameInput.value || 'noname_' + Date.now(),
                prompt: _json_from_textarea.prompt || new_style_positive.value || '',
                negative: _json_from_textarea.negative || new_style_negative.value || '',
                thumb: thumb_data_url || '',
              };

              if( _json ){

                new_style_nameInput.value = _json.name;
                new_style_positive.value = _json.prompt;
                new_style_negative.value = _json.negative;

                const finallyStyles = []; 
                finallyStyles.push( _json );
                while( this.STYLES.length ){
                  const next_ = this.STYLES.shift();
                  finallyStyles.push( next_ );
                }
                this.replaceStyles( finallyStyles );
                this.styles_list_render();
              }
            } );
            
            const { navbar_loadStyles, navbar_saveStyles } = this.elements;

            navbar_loadStyles.addEventListener( 'click', ( e ) => {

              navbar_load_db_upload_file.click();

            } );

            navbar_load_db_upload_file.addEventListener( 'change', ( event ) => {
              const file = event.target.files[0];
              if( file ){
                const fReader = new FileReader();
                fReader.onload = () => {

                  const _text = fReader.result;
                  let _json = null;
                  try{ _json = JSON.parse( _text ); } catch( err ){ console.warn( err ) }
                  if( _json ){
                    this.replaceStyles( _json );
                    this.styles_list_render();
                    console.log( _json );
                  }
                  
                };
                fReader.readAsText( file );
              }
            } );

            navbar_saveStyles.addEventListener( 'click', () => { 

              const jsonData = JSON.stringify( this.STYLES, null, 2);

              // Створюємо об'єкт Blob з JSON-даними
              const blob = new Blob([jsonData], { type: "application/json" });

              // Створюємо URL для завантаження
              const url = URL.createObjectURL(blob);

              // Створюємо посилання і клікаємо по ньому
              const a = document.createElement("a");
              a.href = url;
              a.download = "data.json"; // Ім'я файлу
              a.click();

              // Відключаємо URL, щоб уникнути утечки пам'яті
              URL.revokeObjectURL(url);
            } );


            const { switch_mode } = this.elements;

            switch_mode.forEach( ( el, index ) => {

              el.addEventListener( 'click', ( e ) => {
                switch_mode.forEach( ( el2, index ) => {
                  el2.classList.remove('active');
                } );
                const nextMode = el.dataset.value; 
                this.mode = this.mode != nextMode ? nextMode : ''; 
                if( this.mode === nextMode ) el.classList.add('active');
                this.updateSpecialModesControlElements();
                this.reset_mixed_styles();
                this.styles_list_render();
              } );

            } );

          }

          updateSpecialModesControlElements(){

            const { mix_limiter, randomize_style } = this.elements;

            mix_limiter.classList.add('hidden');
            randomize_style.classList.add('hidden');

            if(  this.mode === 'mixer'  ) mix_limiter.classList.remove('hidden');
            if(  this.mode === 'randomize'  ) randomize_style.classList.remove('hidden');

          }

          style_element_remove( styleIndex ){
            const finallyStyles = []; 
            for( let i = 0; i < this.STYLES.length; i++ ){
              if( i != styleIndex ){
                finallyStyles.push( this.STYLES[i] );
              }
            } 
            this.replaceStyles( finallyStyles );
            this.styles_list_render();
          }

          style_element_add(){

          }

          style_element_edit(){

          }

          style_element_change_position( old_position, next_position ){
            const [element] = this.STYLES.splice( old_position, 1); 
            this.STYLES.splice( next_position, 0, element);
            this.edit_dragstart_index = -1;
            this.edit_next_index = -1;
            this.styles_list_render();
          }



          init(){
            this.recalculateRandomItems();
            this.elements.new_style_canvas.width = this.options.thumb_width;
            this.elements.new_style_canvas.height = this.options.thumb_height;
            $$('#from_positive').value = this.defaults.base_prompt;
            this.initEventListeners();
            this.styles_list_render();
          }

          styles_list_create_element( style_index ){

            const STYLES = this.STYLES;
            const nextSliderElement = document.createElement('div');
            nextSliderElement.classList.add('item');
            if( this.mixed_items.includes( style_index ) ){
              nextSliderElement.classList.add('mixed');
            }

            const nextImg = new Image();
            nextImg.id = `style_image_${style_index}`;
            nextImg.src  = STYLES[ style_index ].thumb;
            nextSliderElement.appendChild( nextImg );
            
            nextSliderElement.addEventListener('click', () => {
              this.options.styles_list_current_index = style_index;
              this.styles_list_process();
            });

            const name_span = document.createElement('span');
            name_span.classList.add('item_name');
            name_span.innerText = STYLES[ style_index ].name;
            nextSliderElement.appendChild( name_span );
            this.elements.slist_container.appendChild( nextSliderElement );

            // disable controls


            if( this.mode === 'mixer' ){
              
              const mixer_checkbox = document.createElement('input');
              mixer_checkbox.classList.add('style_mixer_checkbox');
              mixer_checkbox.type = 'checkbox';
              mixer_checkbox.checked = this.mixed_items.includes( style_index ) ? 'checked' : false;
              nextSliderElement.appendChild( mixer_checkbox );

              mixer_checkbox.addEventListener('click', (event) => { 

                event.preventDefault();
                event.stopPropagation();

                if( this.mixed_items.includes( style_index ) ){
                  this.mixed_items.splice( this.mixed_items.indexOf( style_index ), 1);
                } else {
                  this.mixed_items.push( style_index );
                }

                this.styles_list_render();
                this.render_mixed_style();

              });

            }

            // edit mode addons
            if( this.mode === 'editor' ){

              nextSliderElement.addEventListener('dragstart', (event) => { 
                // event.preventDefault();
                if( this.edit_dragstart_index > -1 ) return false;
                this.edit_dragstart_index = style_index;
              });

              nextSliderElement.addEventListener('dragend', (event) => { 
                event.preventDefault(); 
                this.edit_dragstart_index = -1;
                this.edit_next_index = -1;
              });

              nextSliderElement.addEventListener('dragover', (event) => { 
                event.preventDefault(); 
                if( this.edit_dragstart_index > -1 ){
                  if( this.edit_dragstart_index !== style_index ){
                    const target_index = event.target.id.replace('style_image_',''); 
                    event.target.classList.add('place_before');
                    this.edit_next_index = target_index;
                  } else {
                    this.edit_next_index = -1;
                  }
                }
              });

              nextSliderElement.addEventListener('dragleave', (event) => { 
                event.preventDefault(); 
                nextImg.classList.remove('place_before');
              });

              nextSliderElement.addEventListener('drop', (event) => {

                event.preventDefault();

                if( this.edit_dragstart_index > -1 && this.edit_next_index > -1 ){
                  console.log( 'change_place_event', style_index, event );
                  this.style_element_change_position( this.edit_dragstart_index, this.edit_next_index );
                  return;
                }
                const file = event.dataTransfer.files[0];

                console.log( {
                  options: this.options,
                  file
                } );

                if( file.name === 'download.webp' ) return;
                if (file && file.type.startsWith('image/')) {
                  const freader = new FileReader(), pImage = new Image(), pCan = document.createElement('canvas'), pCtx = pCan.getContext('2d'); 
                  pCan.width = this.options.thumb_width;
                  pCan.height = this.options.thumb_height;
                  freader.onload = (e) => {
                    pImage.onload = () => {
                      pCtx.drawImage( pImage, 0, 0, pImage.width, pImage.height, 0, 0, pCan.width, pCan.height );
                      const dataURL = pCan.toDataURL('image/webp', 0.5 );
                      STYLES[style_index].thumb = dataURL;
                      this.styles_list_render();
                    }
                    pImage.src = e.target.result;
                  };
                  freader.readAsDataURL(file);
                } else {
                    alert('Будь ласка, перетягніть зображення');
                }
              });

              const removeIcon = document.createElement('div');
              removeIcon.innerHTML = 'x';
              removeIcon.classList.add('remove_icon');
              removeIcon.addEventListener( 'click', ( e ) => {
                e.preventDefault();
                e.stopPropagation();
                this.style_element_remove( style_index );
              } );
              nextSliderElement.appendChild( removeIcon );

            }


          }

          compilePromptAndNegative( allPrompts, allNegatives, limitsFromInput = 8, limitsFromInput_negative = 4 ){
            
            
            let allPrompts_finally = [];
            let allNegatives_finally = [];

            for( const nextPrompt of allPrompts ){
              const trimed = nextPrompt.trim();
                if( !allPrompts_finally.includes( trimed ) && trimed !== '' ){
                  allPrompts_finally.push( trimed );
                  if( allPrompts_finally.length >= limitsFromInput ){
                    break;
                  }
                }
            }

            allPrompts_finally = shuffleArray( allPrompts_finally );

            for( const nextNegative of allNegatives ){
              const trimed = nextNegative.trim();
              if( !allNegatives_finally.includes( trimed ) && trimed !== '' ){
                allNegatives_finally.push( trimed );
                if( allNegatives_finally.length >= limitsFromInput_negative ){
                  break;
                }
              }
            }

            allNegatives_finally = shuffleArray( allNegatives_finally );

            return {
              prompt: allPrompts_finally,
              negative: allNegatives_finally
            };

          }

          combineMixedStyles( miexdStyles ){

            const { mix_limiter_input } = this.elements; 
            const limitsFromInput = parseInt( mix_limiter_input.value ) || maxLimits;
            const limitsFromInput_negative = Math.floor( limitsFromInput * 0.5 );
 
            const allNames = [];
            let allPrompts = [];
            let allNegatives = [];

            for( const nextIndex of miexdStyles ){ 
              const { name, prompt, negative } = this.STYLES[ nextIndex ];

              allNames.push( name );

              const prompt_withoutPromptTag = prompt.replaceAll('{prompt}', '');
              const prompt_splitedByComa = prompt_withoutPromptTag.split(',');
              allPrompts = allPrompts.concat( prompt_splitedByComa );

              const negative_withoutPromptTag = negative.replaceAll('{prompt}', '');
              const negative_splitedByComa = negative_withoutPromptTag.split(',');
              allNegatives = allNegatives.concat( negative_splitedByComa );
            }
 
            const { prompt, negative } = this.compilePromptAndNegative( allPrompts, allNegatives, limitsFromInput, limitsFromInput_negative );

            let allPrompts_finally = prompt;
            let allNegatives_finally = negative;
            let allNames_finally = [];
            for( const nextName of allNames ){
              allNames_finally.push( nextName.trim() );
            }

            return {
              name: allNames_finally.join(' + '),
              prompt:  '{prompt},' + allPrompts_finally.join(', '),
              negative: allNegatives_finally.join(', '),
            };
          }

          


          // nextOption = { name: '', prompt: '', negative: '' }
          render_finally_item( nextOption ){
            const { slist_fromPositive, slist_fromNegative, slist_toPositive, slist_toNegative, slist_selected_style_name } = this.elements;
            if( !nextOption ){
              slist_toPositive.value = 'there is no selected style';
              slist_toNegative.value = 'there is no selected style';
              return;
            }
            slist_selected_style_name.innerText = nextOption.name;
            slist_toPositive.value = nextOption.prompt.replaceAll( '{prompt}', slist_fromPositive.value );
            slist_toNegative.value = nextOption.negative; //.replaceAll( '{prompt}', fromNegative.value );  
            $$('#build_for_tele').value = `/generate prompt:${slist_toPositive.value} negative_prompt:${slist_toNegative.value} style:sdxl-portrait amount:1`;
          }

          render_mixed_style(){
            const { slist_fromPositive, slist_fromNegative, slist_toPositive, slist_toNegative, slist_selected_style_name } = this.elements; 
            if( this.mixed_items.length < 1 ) {
              this.render_finally_item( null ); 
            } else if( this.mixed_items.length === 1 ) { 
              const nextOptions = this.STYLES[ this.mixed_items[0] ];
              this.render_finally_item( nextOptions ); 
            } else if( this.mixed_items.length > 1 ) {  
              const nextOptions =  this.combineMixedStyles( this.mixed_items ); 
              this.render_finally_item( nextOptions ); 
            }
          }
          
          styles_list_process(){
            const nextOptions = this.STYLES[ this.options.styles_list_current_index ];
            this.render_finally_item( nextOptions ); 
          }
 
          render_random_style(){
            
            const { randomize_limiter_input } = this.elements; 
            const limitsFromInput = parseInt( randomize_limiter_input.value ) || maxLimits;
            const limitsFromInput_negative = Math.floor( limitsFromInput * 0.5 );

            let { prompt, negative } = this.stack_items_for_randmoize;
            prompt = shuffleArray( prompt );
            negative = shuffleArray( negative );


            const { prompt: allPrompts_finally, negative: allNegatives_finally } = this.compilePromptAndNegative( prompt, negative, limitsFromInput, limitsFromInput_negative );
            
            this.render_finally_item( {
              name: 'random style',
              prompt:  '{prompt},' + allPrompts_finally.join(', '),
              negative: allNegatives_finally.join(', '),
            } ); 

          }

          styles_list_render(){
            this.elements.slist_container.innerHTML = "";
            for( let i = 0; i < this.STYLES.length; i++ ){
              this.styles_list_create_element( i );
            }
          }

        }

        const _Editor = new StylerEditor('https://raw.githubusercontent.com/834t/tools/refs/heads/main/prompting/styles_data.json');

      };



      // let STYLES = [];
      const tabs = new Tabby('[data-tabs]');
    </script>

    
  </body>
</html>
